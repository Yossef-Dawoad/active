{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <title>Website</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="{% static 'https://fonts.googleapis.com/css?family=Quicksand:300,400,500,700,900|Oswald:400,700"
    rel="stylesheet' %} " />
  <link href="{% static 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet' %} "
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap-switch-button@1.1.0/css/bootstrap-switch-button.min.css"
    rel="stylesheet" />
  <link rel="stylesheet" href=" {% static 'fonts/icomoon/style.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/all.min.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/bootstrap.min.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/bootstrap-rtl.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/magnific-popup.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/jquery-ui.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/owl.carousel.min.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/owl.theme.default.min.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/bootstrap-datepicker.css' %} " />
  <link rel="stylesheet" href=" {% static 'fonts/flaticon/font/flaticon.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/aos.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/rome.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/fancybox.min.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/style.css' %} " />
  <link rel="stylesheet" href=" {% static 'css/style2.css' %} " />
</head>

<body data-spy="scroll" data-target=".site-navbar-target" data-offset="200">

  <nav class="navbar sticky-top navbar-expand-lg navbar-dark bg-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01"
      aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
      <a class="navbar-brand" href="#home">Eye +</a>
      <ul class="navbar-nav mr-auto mt-2 mt-lg-0 nav-pills nav-fill">
        <li class="nav-item ">
          <a class="nav-link active" href="#home">HOME <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#controls">CONTROLS </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#videos">Videos </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'ad_index' %}"> Attendance </a>
        </li>


        <!--
        <li class="nav-item">
          <a class="nav-link" href="#contact">CONTACT </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/login/">LOGIN </a>
        </li> -->
      </ul>
    </div>
  </nav>


  <!-- #sections -->
  <div class="d-flex justify-content-center" id="home">
    <main class="main-content">
      <div class="container-fluid">

        <section class="site-section stream">
          <div class="row m-3">
            <div class="col-md-9 themed-grid-col">
              <h2 class="heading text-uppercase text-dark">Streaming</h2>
              <article class="col-12 my-3 py-3 aos-init stream aos-animate" data-aos="fade-up">
                <figure>
                  <a href="https://www.youtube.com/embed/w36ZmkgkPww" class="d-block photo-item"
                    data-fancybox="gallery">
                    <img src="{% static 'images/bg.jpg' %}" id="video-stream" alt="Image" class="img-fluid"
                      style="height: 400px; width: 600px;">
                    <div class="photo-text-more">
                    </div>
                  </a>
                </figure>
              </article>
            </div>

            <!-- last videoes -->
            <div class="col-md-3 themed-grid-col">
              <div class="pb-3">
                <article class="col-12 my-3 py-3 aos-init stream aos-animate" data-aos="fade-up">
                  <h1> Recognized Faces </h1>
                  <p id="facerecognized"></p>
                  <h3 class="font-weight-light text-dark text-center mb-3">
                    Last Videos
                  </h3>

                  {% for file in last_videos %}

                  <figure class="mb-4">
                    <a href={{ file }} class="d-block photo-item" data-fancybox="gallery">
                      <img src="{% static 'images/bg.jpg' %} " alt="Image" class="img-fluid" />
                      <div class="photo-text-more">
                      </div>
                    </a>
                  </figure>
                  {% endfor %}

                </article>
              </div>
            </div>
          </div>
        </section>



        <hr>
        <!-- Control  -->
        <section class="site-section controls" id="controls">
          <h2 class="heading text-uppercase text-dark">Controls</h2>
          <div class="row row-cols-4 m-5">

            <div class="col-12 col-md-6 col-lg-3 my-2">
              <button type="button" id="unlock" class="btn btn-toggle p-3 w-100 btn-danger"><i
                  class="pr-1 fas fa-unlock pr-2" aria-hidden="true"></i>Un/Locked</button>
            </div>


            <div class="col-12 col-md-6 col-lg-3 my-2">
              <button type="button" id="object" class="btn btn-toggle p-3 w-100 btn-success"><i
                  class="pr-1 fa-solid fa-images" aria-hidden="true"></i>Object Detection</button>
            </div>
            <div class="col-12 col-md-6 col-lg-3 my-2">
              <button type="button" id="test1" class="btn btn-toggle p-3 w-100 btn-danger"><i
                  class="pr-1 fas fa-unlock pr-2" aria-hidden="true"></i>Day and Night</button>
            </div>
            <div class="col-12 col-md-6 col-lg-3 my-2">
              <button type="button" id="test2" class="btn btn-toggle p-3 w-100 btn-success"><i
                  class="pr-1 fas fa-unlock pr-2" aria-hidden="true"></i>Un/Locked</button>
            </div>
          </div>
        </section>
        <hr>




        <section class="site-section row align-items-stretch photos" id="videos">
          <div class="col-12">
            <h2 class="heading text-uppercase text-dark">Recording Videos</h2>

            <div class="row align-items-stretch m-3">


              {% for video in pageObj %}
              <article class="col-12 col-md-6 col-lg-4" data-aos="fade-up">
                <figure>
                  <a href="{{ video }}" class="d-block photo-item" data-fancybox="gallery">

                    <img src="{% static 'images/bg.jpg' %} " alt="Image" class="img-fluid" />
                    <div class="photo-text-more">
                      <span class="icon icon-search"></span>
                    </div>
                  </a>
                </figure>
                <!-- <h2 class="font-weight-light text-dark text-center">
                      {{ Vname }}
                    </h2> -->
              </article>
              {% endfor %}
              <br>


              <div class="pagination">
                <span class="step-links">
                  {% if pageObj.has_previous %}
                  <a href="?page=1">&laquo; first</a>
                  <a href="?page={{ pageObj.previous_page_number }}">previous</a>
                  {% endif %}

                  <span class="current">
                    Page {{ pageObj.number }} of {{ pageObj.paginator.num_pages }}.
                  </span>

                  {% if pageObj.has_next %}
                  <a href="?page={{ pageObj.next_page_number }}">next</a>
                  <a href="?page={{ pageObj.paginator.num_pages }}">last &raquo;</a>
                  {% endif %}
                </span>
              </div>

            </div>
          </div>
        </section>

        <hr>

 
      </div>
    </main>
  </div>


  <script src=" {% static 'js/jquery-3.3.1.min.js' %} "></script>
  <script src=" {% static 'js/jquery-migrate-3.0.1.min.js' %} "></script>
  <script src=" {% static 'js/jquery.easing.1.3.js' %} "></script>
  <script src=" {% static 'js/jquery-ui.js' %} "></script>
  <script src=" {% static 'js/popper.min.js' %} "></script>
  <script src=" {% static 'js/bootstrap.min.js' %} "></script>
  <script src=" {% static 'js/owl.carousel.min.js' %} "></script>
  <script src=" {% static 'js/jquery.stellar.min.js' %} "></script>
  <script src=" {% static 'js/jquery.countdown.min.js' %} "></script>
  <script src=" {% static 'js/jquery.magnific-popup.min.js' %} "></script>
  <script src=" {% static 'js/bootstrap-datepicker.min.js' %} "></script>
  <script src=" {% static 'js/rome.js' %} "></script>
  <script src=" {% static 'js/aos.js' %} "></script>
  <script
    src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap-switch-button@1.1.0/dist/bootstrap-switch-button.min.js"></script>
  <script src=" {% static 'js/jquery.fancybox.min.js' %} "></script>
  <script src=" {% static 'js/main.js' %} "></script>
  <script src=" {% static 'js/master.js' %} "></script>

  <script>
    const socket = new WebSocket(`ws://${window.location.host}/ws/video/feed/`);
    let btn = document.querySelector('#unlock');
    ////////////////////////////////////////////////////
    const facerecog = document.getElementById('facerecognized');
    var detectedfaces;
    ///////////////////////////////////////if self.tt.time_pass(60):
    let video_feed = document.querySelector('#video-stream');
    const socket_lock = new WebSocket(
      `ws://${window.location.host}/ws/activelock/`
    );

    socket_lock.onmessage = function (e) {
      const wsdata = JSON.parse(e.data);
      // console.log(wsdata)
      //    update button state 
    };

    socket_lock.onclose = function (e) {
      console.error('websocket closed unexpectedly');
      console.error(e);
    };

    function getLastState_sendRequest(){
      fetch(`http://${window.location.host}/lock_api/last-state/`)
          .then(response => response.json())
          .then(data => socket_lock.send(
                            JSON.stringify(
                              {
                                "message":{
                                  "state": !data['state'],
                                  "validated": false,
                                  // "method": "web"
                                }
                              }
                            )
                        )
          ).catch(error => console.log(error));
    }

    btn.onclick = function (e) {

      getLastState_sendRequest();
      // update button state

    }


    socket.onmessage = async (e) => {
      let recieved_data = e.data
      if (typeof recieved_data === 'string') {
        var data = JSON.parse(e.data);
        detectedfaces = data['facename']; // list of faces recocnized
        if (detectedfaces.includes("yousef")) {
         
          socket_lock.send(
            JSON.stringify(
                    {
                      "message":{
                        "state": true,
                        "validated": false,
                        "method": "face-detection"
                      }
                    }
              )
          )
          btn.click();
        }
        facerecog.innerHTML = detectedfaces;
        // console.log(detectedfaces);
      }

      else {
        let url = URL.createObjectURL(recieved_data)
        video_feed.src = url
      }
    }


  </script>
</body>

</html>